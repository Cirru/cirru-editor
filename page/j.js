// Generated by CoffeeScript 1.3.3
var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

$(function() {
  var blank, branch, cursor, editable, empty, exist, focus, in_sight, leaf, p, paste, point, t, target;
  editable = 'contenteditable';
  cursor = "<code id='target' " + editable + "='true'/>";
  blank = ['', '<br>'];
  paste = '';
  p = function() {
    return $('#point');
  };
  t = function() {
    return $('#target');
  };
  empty = function(elem) {
    var _ref;
    return _ref = elem.html(), __indexOf.call(blank, _ref) >= 0;
  };
  branch = function(elem) {
    if (elem.parent().attr('id') !== 'editor') {
      return true;
    } else {
      return false;
    }
  };
  exist = function(elem) {
    return elem.length > 0;
  };
  leaf = function(elem) {
    return elem[0].tagName === 'CODE';
  };
  target = function(elem) {
    return elem.attr('id', 'point').attr(editable, 'true');
  };
  point = function(refocus) {
    var old, up;
    if (refocus == null) {
      refocus = true;
    }
    old = p().removeAttr('id').removeAttr(editable);
    if (exist(old)) {
      old[0].onclick = function(e) {
        old.attr('id', 'target').attr(editable, 'true');
        this.onclick = {};
        point(false);
        e.preventDefault();
        return false;
      };
      while ((empty(old)) && (branch(old))) {
        up = old.parent();
        old.remove();
        old = up;
      }
    }
    target(t());
    if (refocus) {
      return focus();
    }
  };
  focus = function() {
    var sel;
    sel = window.getSelection();
    sel.collapse(p()[0], 1);
    $('div').addClass('inline');
    $('div:has(div)').removeClass('inline');
    return p().focus();
  };
  $('#editor').append(cursor);
  t().attr('id', 'point');
  focus();
  $('#editor').click(function() {
    return console.log('called');
  });
  in_sight = true;
  $('#editor').bind('focus', function() {
    return in_sight = true;
  });
  $('#editor').bind('blur', function() {
    return in_sight = false;
  });
  $('#editor').keydown(function(e) {
    var elems, it, next, old, prev, up, _ref, _ref1, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7;
    console.log(e.keyCode);
    if (in_sight) {
      switch (e.keyCode) {
        case 13:
          p().after("<div>" + cursor + "</div>");
          break;
        case 9:
          p().after(cursor);
          break;
        case 46:
          if (exist(p().prev())) {
            it = p().prev();
            if (leaf(it)) {
              it.attr('id', 'target');
            } else {
              it.append(cursor);
            }
          } else if (exist(p().next())) {
            it = p().next();
            if (leaf(it)) {
              it.attr('id', 'target');
            } else {
              it.prepend(cursor);
            }
          } else if (branch(p())) {
            p().parent().after(cursor).remove();
          } else if (_ref = p().html(), __indexOf.call(blank, _ref) < 0) {
            p().after(cursor);
          } else {
            return true;
          }
          p().remove();
          break;
        case 38:
          if (_ref1 = $('.point').html(), __indexOf.call(empty, _ref1) < 0) {
            old = pop_point($('.point'));
            old.before(cursor);
          } else if ($('.point').prev().length > 0) {
            prev = $('.point').prev();
            if (prev[0].tagName === 'DIV') {
              set_point($('.point').prev());
            } else if (prev[0].tagName === 'SECTION') {
              prev.append(cursor);
            }
            $('.point')[1].outerHTML = '';
          } else if ($('.point').parent().attr('id') !== 'editor') {
            $('.point').parent().before(cursor);
            old = $('.point').last();
            up = old.parent();
            old.remove();
            if (_ref2 = up.html(), __indexOf.call(empty, _ref2) >= 0) {
              up.remove();
            }
          }
          focus();
          break;
        case 40:
          if (_ref3 = $('.point').html(), __indexOf.call(empty, _ref3) < 0) {
            old = pop_point($('.point'));
            old.after(cursor);
          } else if ($('.point').next().length > 0) {
            next = $('.point').next();
            if (next[0].tagName === 'DIV') {
              set_point($('.point').next());
            } else if (next[0].tagName === 'SECTION') {
              next.prepend(cursor);
            }
            $('.point').first().remove();
          } else if ($('.point').parent().attr('id') !== 'editor') {
            $('.point').parent().after(cursor);
            old = $('.point').first();
            up = old.parent();
            old.remove();
            if (_ref4 = up.html(), __indexOf.call(empty, _ref4) >= 0) {
              up.remove();
            }
          }
          focus();
          break;
        case 89:
          up = $('.point').parent();
          if (e.ctrlKey && up[0].tagName === 'SECTION') {
            up.after(cursor);
            elems = pop_point($('.point').first());
            while (_ref5 = elems.text(), __indexOf.call(empty, _ref5) >= 0) {
              if (!elems.parent().has($('.point'))) {
                up = elems.parent();
                elems.remove();
                elems = up;
              } else {
                break;
              }
            }
            paste = up[0].outerHTML || '';
            up.remove();
            focus();
          } else {
            return true;
          }
          break;
        case 85:
          if (e.ctrlKey && paste.length > 0) {
            $('.point').before(paste);
          } else {
            return true;
          }
          break;
        case 33:
          old = $('.point');
          up = old.parent();
          if (up.attr('id') !== 'editor') {
            up.before(cursor);
            pop_point(old);
            if (_ref6 = old.html(), __indexOf.call(empty, _ref6) >= 0) {
              old.remove();
              if (up.children().length === 0) {
                up.remove();
              }
            }
          }
          focus();
          break;
        case 34:
          old = $('.point');
          up = old.parent();
          if (up.attr('id') !== 'editor') {
            up.after(cursor);
            pop_point(old);
            if (_ref7 = old.html(), __indexOf.call(empty, _ref7) >= 0) {
              old.remove();
              if (up.children().length === 0) {
                up.remove();
              }
            }
          }
          focus();
          break;
        default:
          return true;
      }
      point();
    }
    return false;
  });
  return window.parse = function() {
    var map, res;
    map = function(item) {
      var res;
      if (item.tagName === 'DIV') {
        return item.innerText;
      } else if (item.tagName === 'SECTION') {
        console.log(item.children);
        res = $.map(item.children, function(x) {
          return map(x);
        });
        return [res];
      }
    };
    res = $.map($('#editor')[0].children, map);
    return console.log('res:', res);
  };
});
